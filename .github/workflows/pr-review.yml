name: PR Review & Quality Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

# Permissions for posting comments
permissions:
  contents: read
  pull-requests: write
  issues: write

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Build & Type Check
  # ============================================
  build:
    name: Build & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

  # ============================================
  # Lint & Format
  # ============================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check Prettier formatting
        run: npx prettier --check "**/*.{ts,tsx,js,jsx,json,md,css}"

  # ============================================
  # Test Suite
  # ============================================
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Generate coverage report
        if: always()
        run: npm run test:coverage

      - name: Upload coverage to artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Comment test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let body = '## üß™ Test Results\n\n';
            
            try {
              // Read coverage summary if available
              const coveragePath = 'coverage/coverage-summary.json';
              if (fs.existsSync(coveragePath)) {
                const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
                const total = coverage.total;
                
                body += '### Coverage Summary\n\n';
                body += '| Metric | Coverage |\n';
                body += '|--------|----------|\n';
                body += `| Statements | ${total.statements.pct}% |\n`;
                body += `| Branches | ${total.branches.pct}% |\n`;
                body += `| Functions | ${total.functions.pct}% |\n`;
                body += `| Lines | ${total.lines.pct}% |\n\n`;
                
                if (total.statements.pct < 80) {
                  body += '‚ö†Ô∏è **Warning**: Coverage is below 80% target.\n\n';
                } else {
                  body += '‚úÖ **Great!** Coverage meets 80% target.\n\n';
                }
              }
              
              body += 'üìä [View full coverage report in artifacts](../actions/runs/${{ github.run_id }})\n';
              
            } catch (e) {
              body += '‚ö†Ô∏è Could not read coverage report.\n';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ============================================
  # Security Audit
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for known vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # ============================================
  # PR Size & Complexity Check
  # ============================================
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.reduce((sum, file) => sum + file.deletions, 0);
            const totalChanges = additions + deletions;
            const fileCount = files.length;
            
            let sizeLabel = 'size/S';
            let sizeEmoji = 'üü¢';
            let message = '';
            
            if (totalChanges > 1000 || fileCount > 30) {
              sizeLabel = 'size/XL';
              sizeEmoji = 'üî¥';
              message = '‚ö†Ô∏è **Large PR detected!** Consider breaking this into smaller PRs for easier review.';
            } else if (totalChanges > 500 || fileCount > 15) {
              sizeLabel = 'size/L';
              sizeEmoji = 'üü†';
              message = 'üìù This PR is on the larger side. Consider if it can be split.';
            } else if (totalChanges > 200 || fileCount > 8) {
              sizeLabel = 'size/M';
              sizeEmoji = 'üü°';
            }
            
            const summary = `
            ## üìä PR Size Analysis
            
            | Metric | Count |
            |--------|-------|
            | Files changed | ${fileCount} |
            | Additions | +${additions} |
            | Deletions | -${deletions} |
            | Total changes | ${totalChanges} |
            
            **Size**: ${sizeEmoji} ${sizeLabel}
            
            ${message}
            `;
            
            // Add comment to PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
            
            // Add label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [sizeLabel]
              });
            } catch (e) {
              console.log('Could not add label:', e.message);
            }

  # ============================================
  # SEO & Content Check (Real Estate Specific)
  # ============================================
  seo-check:
    name: SEO & Content Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for SEO requirements
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const issues = [];
            const warnings = [];
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const pageFiles = files.filter(f => 
              f.filename.includes('app/') && 
              f.filename.endsWith('page.tsx') &&
              f.status !== 'removed'
            );
            
            for (const file of pageFiles) {
              try {
                const content = fs.readFileSync(file.filename, 'utf8');
                
                // Check for metadata export
                if (!content.includes('export const metadata') && !content.includes('generateMetadata')) {
                  issues.push(`‚ùå **${file.filename}**: Missing metadata export (SEO)`);
                }
                
                // Check for proper phone numbers
                if (content.includes('702-222-1964') || content.includes('7022221964') || 
                    content.includes('702-500-1955') || content.includes('7025001955')) {
                  issues.push(`‚ùå **${file.filename}**: Contains old phone number (should be (702) 500-1942)`);
                }
                
                // Check for JSON-LD schema
                if (!content.includes('application/ld+json') && !content.includes('schema.org')) {
                  warnings.push(`‚ö†Ô∏è **${file.filename}**: Consider adding JSON-LD schema markup`);
                }
                
                // Check for H1 tag
                if (!content.includes('<h1') && !content.includes('<H1')) {
                  warnings.push(`‚ö†Ô∏è **${file.filename}**: No H1 tag found`);
                }
                
                // Check for Berkshire Hathaway branding
                if (!content.includes('Berkshire Hathaway') && !content.includes('BHHS')) {
                  warnings.push(`‚ö†Ô∏è **${file.filename}**: Missing Berkshire Hathaway branding`);
                }
                
              } catch (e) {
                console.log(`Could not read ${file.filename}:`, e.message);
              }
            }
            
            if (issues.length > 0 || warnings.length > 0) {
              let body = '## üîç SEO & Content Review\n\n';
              
              if (issues.length > 0) {
                body += '### ‚ùå Issues (Must Fix)\n' + issues.join('\n') + '\n\n';
              }
              
              if (warnings.length > 0) {
                body += '### ‚ö†Ô∏è Warnings (Consider)\n' + warnings.join('\n') + '\n\n';
              }
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              
              if (issues.length > 0) {
                core.setFailed('SEO issues found - see PR comments');
              }
            }

  # ============================================
  # Auto-label PR
  # ============================================
  labeler:
    name: Auto Label
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label PR based on files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const labels = new Set();
            
            for (const file of files) {
              const path = file.filename;
              
              if (path.includes('app/') && path.endsWith('page.tsx')) {
                labels.add('pages');
              }
              if (path.includes('components/')) {
                labels.add('components');
              }
              if (path.includes('neighborhoods/')) {
                labels.add('neighborhoods');
              }
              if (path.includes('buyers/') || path.includes('sellers/')) {
                labels.add('personas');
              }
              if (path.includes('55-plus')) {
                labels.add('55+');
              }
              if (path.includes('.github/')) {
                labels.add('ci/cd');
              }
              if (path.includes('api/')) {
                labels.add('api');
              }
              if (path.endsWith('.css') || path.includes('tailwind')) {
                labels.add('styles');
              }
            }
            
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labels)
                });
              } catch (e) {
                console.log('Could not add labels:', e.message);
              }
            }

  # ============================================
  # Summary Comment
  # ============================================
  summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: [build, lint, test, security]
    if: always()
    steps:
      - name: Post summary
        uses: actions/github-script@v7
        with:
          script: |
            const buildResult = '${{ needs.build.result }}';
            const lintResult = '${{ needs.lint.result }}';
            const testResult = '${{ needs.test.result }}';
            const securityResult = '${{ needs.security.result }}';
            
            const getEmoji = (result) => {
              if (result === 'success') return '‚úÖ';
              if (result === 'failure') return '‚ùå';
              if (result === 'skipped') return '‚è≠Ô∏è';
              return '‚ö†Ô∏è';
            };
            
            const body = `
            ## ü§ñ Automated PR Review Summary
            
            | Check | Status |
            |-------|--------|
            | Build & Type Check | ${getEmoji(buildResult)} ${buildResult} |
            | Lint & Format | ${getEmoji(lintResult)} ${lintResult} |
            | Test Suite | ${getEmoji(testResult)} ${testResult} |
            | Security Audit | ${getEmoji(securityResult)} ${securityResult} |
            
            ---
            
            ${buildResult === 'failure' || lintResult === 'failure' || testResult === 'failure' ? '‚ö†Ô∏è **Action required**: Please fix the failing checks before merging.' : 'üéâ All automated checks passed!'}
            
            <details>
            <summary>üìã Review Checklist</summary>
            
            - [ ] Code follows project conventions
            - [ ] Tests pass with adequate coverage (80%+)
            - [ ] SEO metadata is present and optimized
            - [ ] Phone numbers are correct: (702) 500-1942
            - [ ] Berkshire Hathaway branding is consistent
            - [ ] Mobile responsive design verified
            - [ ] No console errors
            
            </details>
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
